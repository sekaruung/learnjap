function enterLBlank(e,target){return 13==(window.event?window.event.keyCode:e.which)&&""!=$(target).val()&&checkLAnswer(target),!0}function checkLAnswer(el){$(el).css("color",""),$(el).val()==$(el).data("answer")||$(el).val()==$(el).data("kanswer")?$(el).closest(".flexbox").hide().prev().show():$(el).css("color","red")}function adjustQSTyle(el){$(el).addClass("selected"),$(el).siblings().removeClass("selected"),$(el).parent().siblings().hide().filter("#qstyle_"+$(el).data("qstyle")).show()}function adjustPSTyle(el){$(el).addClass("selected"),$(el).siblings().removeClass("selected"),$(el).parent().siblings().hide().filter("#pstyle_"+$(el).data("qstyle")).show()}function selectCPuzzle(piece,booktype){$(piece).addClass("selected").siblings().removeClass("selected"),$.each($(piece).parent().siblings(),(function(){$(this).toggle($(this).attr("id")=="cpuzzle_"+booktype)}))}function gameResponse(el){$(el).hasClass("counter_correct")||$(el).hasClass("counter_incorrect")||(isCorrect=void 0!==el&&"1"==$(el).data("correct"),parent=$(el).closest("#game_ans"),$.each(parent.find("label"),(function(){cCorrect="1"==$(this).data("correct"),$(this).off("click"),cCorrect?$(this).addClass("counter_correct"):$(this).addClass("counter_incorrect")})),answerData={answer:void 0!==el?$(el).data("answer"):""},isCorrect?updateHP(1,"enemy",{hpAdjust:-6}):updateHP(0,"hero",{hpAdjust:-10}),setTimeout((function(){$(el).closest(".game_problem").hide().next().show(),"game_problem3"==$(el).closest(".game_problem").attr("id")&&$("#game_field").hide()}),3e3))}function updateHP(monsterID,key,opts){return newHP=parseInt(_monsters[key][monsterID].currentHP)+parseInt(opts.hpAdjust),newHP<0&&(newHP=0),_monsters[key][monsterID].currentHP=newHP,hpPerc=_monsters[key][monsterID].currentHP/_monsters[key][monsterID].totalHP,$("#monster_"+monsterID+" .monster_gauge > div").css("width",100*hpPerc+"%"),visResult=updateMonsterVisual(monsterID,key),parseInt(opts.hpAdjust)<0&&!opts.noAnim&&(useAnim="hero"==key?"hitRight":"hitLeft",$("#monster_"+monsterID+" .monster_unit").removeClass("swoopInRight swoopInLeft"),$("#monster_"+monsterID+" .monster_unit").addClass(useAnim),setTimeout((function(){$("#monster_"+monsterID+" .monster_unit").removeClass(useAnim)}),1e3)),hpPerc>0}function updateMonsterVisual(monsterID,key){_hpPerc=Math.ceil(_monsters[key][monsterID].currentHP/_monsters[key][monsterID].totalHP*100),0==_hpPerc&&animateMonster(monsterID,key,"leave");var useThreshold=!1;for(i in _monsters[key][monsterID].img.steps)if(_hpPerc<=parseInt(i)){useThreshold=i;break}var usePrefix="";_monsters[key][monsterID].opts.img_prefix&&(usePrefix=_monsters[key][monsterID].opts.img_prefix),$("#monster_"+monsterID+" .monster_unit").css({backgroundImage:"url('/i/img/game/"+_monsters[key][monsterID].img.steps[useThreshold][usePrefix+"src"]+"')"})}function scrollLChat(el){if($(el).isInViewport()){var elementBottom=$(el).offset().top+$(el).outerHeight();$(window).scrollTop()+$(window).height()-elementBottom<100&&$("html, body").stop().animate({scrollTop:$(window).scrollTop()+100},200,"swing")}}function startPPath(el){if("1"!=$(el).data("loaded")){$(el).data("loaded","1");let thought_1=$("#p"+$(el).data("qstyle")+"_thought_1");thought_1.show(),scrollLChat(el),setTimeout((function(){finishProgress(thought_1)}),3e3)}}function animateProgress(id){let progressbar=$(id),max=progressbar.attr("max"),time=1e3/max*2.3,value=progressbar.val();const animate=setInterval(()=>(value+=1,progressbar.val(value),void(value==max&&(clearInterval(animate),finishProgress(id)))),time)}function finishProgress(id){if($(id).closest(".p_unit").find(".p_finished").removeClass("rhidden"),$(id).data("next"))if(-1!=$(id).data("next").indexOf("thought")){let next=$("#"+$(id).data("next"));next.removeClass("rhidden"),scrollLChat(next),setTimeout((function(){finishProgress(next)}),3e3)}else{let nextSet=$(id).data("next").split(",");for(_next in nextSet){let next=$("#"+nextSet[_next]);next.closest(".p_unit").show(),scrollLChat(next),animateProgress(next)}}}function processIFeature(){level=$("#k_ifeature").val(),$.each($("#ifeature_1").find("ruby[data-klevel]"),(function(){klevel=$(this).data("klevel"),klevel>level?($(this).children("rb").eq(0).hide(),$(this).children("rb").eq(1).show(),$(this).children("rt").html("&nbsp;")):($(this).children("rb").eq(1).hide(),$(this).children("rb").eq(0).show(),level<=3?$(this).children("rt").html($(this).children("rt").data("furi")):$(this).children("rt").html("&nbsp;"))}))}function dropAnswerCheck(event,ui){drag=ui.draggable,drop=$(this),0==checkDraggable(drag)&&dropAnswer(drag,drop,ui.helper)}function checkDraggable(el){var foundAlready=!1;return $.each($(".squiz_rei input.draggable_input"),(function(){$(this).val()===$(el).data("index")&&(foundAlready=!0)})),foundAlready}function insertDraggable(el){var foundAlready=!1;if($.each($(".squiz_rei input.draggable_input"),(function(){""!=$(this).val()&&$(this).val()==$(el).data("index")&&(foundAlready=!0)})),!foundAlready){var foundTarget=!1;$.each($(".squiz_rei input.draggable_input"),(function(){""!==$(this).val()||foundTarget||(droppable=$(this).prev().droppable(),draggable=$(el).draggable(),dropAnswer($(el),$(this).prev()),foundTarget=!0)}))}}function dropAnswerWrap(event,ui){drag=ui.draggable,drop=$(this),dropAnswer(drag,drop,ui.helper)}function dropAnswer(){drag=$(dropAnswer.arguments[0]),drop=$(dropAnswer.arguments[1]),drag_helper=$(dropAnswer.arguments[2]),void 0!==drag.attr("id")&&void 0!==drop.attr("id")&&(1==drop.find("select").length?drop_index=drop.find("select").val():drop_index="",orig=drop.html(),drop.html(drag.html()),aindex=drop.attr("id").substr(drop.attr("id").indexOf("_")+1),aval=$("#answer_val_"+aindex),"v"==drag.attr("id").substr(0,1)||drag.hasClass("sent_piece")?(hde(drag),newval=drag.attr("id").substr(drag.attr("id").indexOf("_")+1),""!=aval.val()&&aval.val()!=newval&&(olddrag=$("#value_"+aval.val()),shw(olddrag)),aval.val(newval)):(drag.html(orig),""!=drop_index&&returnEl(drag).find("select").val(drop_index),aindex2=drag.attr("id").substr(drag.attr("id").indexOf("_")+1),aval2=$("#answer_val_"+aindex2),aorig=aval.val(),aval.val(aval2.val()),aval2.val(aorig)),parent=$(drop).closest(".pure-form"),$.each(parent.find(".ui-draggable"),(function(){$(this).removeClass("red green"),$(this).data("index")&&$(this).children("span").data("index")&&$(this).addClass($(this).children("span").data("index")==$(this).data("index")?"green":"red")})))}function hlStroke(){$.each($(".ui-droppable"),(function(){$(this).addClass("highlight_drop")}))}function hoStroke(){$.each($(".ui-droppable"),(function(){$(this).removeClass("highlight_drop")}))}$.fn.isInViewport=function(){var elementTop=$(this).offset().top,elementBottom=elementTop+$(this).outerHeight(),viewportTop=$(window).scrollTop(),viewportBottom=viewportTop+$(window).height();return elementBottom>viewportTop&&elementTop<viewportBottom};
