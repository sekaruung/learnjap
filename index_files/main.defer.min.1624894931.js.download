function adoptList(list_id,action){"save"==action?(shw("#adopted_btns"),hde("#adopt_btns")):(shw("#adopt_btns"),hde("#adopted_btns")),alterList(list_id,action)}function updateList(row,list_id,el){el&&returnEl(el).html("Updated to the newest version."),alterList(list_id,"update")}function alterList(list_id,action){callAjax("custom/list_adopt&list_id="+list_id+"&action="+action)}function delMsg(el,bid,dec,force){force?(hde("message_"+bid+"_full"),callAjax("user/messages_del&bid="+bid)):_confirm($(el).data("confirm"),function(){hde("message_"+bid+"_full"),callAjax("user/messages_del&bid="+bid)})}function sendSuki(curr_points,id,type){already=$(curr_points).data("already"),"1"!=already&&(type=type||"suki",callAjax("misc/reibun_suki&id="+id+"&type="+type),returnEl(curr_points).removeClass("suki_button"),returnEl(curr_points).addClass("suki_button_on"),$(curr_points).data("already","1"),curr_points=parseInt(returnEl(type+"_"+id).html()),returnEl(type+"_"+id).addClass("green"),returnEl(type+"_"+id).html(curr_points+1))}function saveBunpou(id,type){callAjax("grammar/save&id="+id+"&type="+type),"add"==type?(hde("bsave_add"),shw("bsave_rem")):(hde("bsave_rem"),shw("bsave_add"))}function saveUReibun(curr_saved,id,type){type=type||"add",callAjax("misc/reibun_saved&id="+id+"&type="+type),curr_saved.removeClass("tlnk"),"add"==type?curr_saved.html("saved to sentence library"):curr_saved.html("removed from sentence library"),curr_saved.onclick="";curr_saved=parseInt($("#saved_"+id).html());$("#saved_"+id).html(curr_saved+("add"==type?1:-1))}function sendGiftEmailPost(xml){jsonarr=preProcessJSON(xml),jsonarr.error?($("#gift_button").prop("disabled",!1),$("#gift_button").val($("#gift_button").data("enabled")),$("#gift_error").html(makeError(jsonarr.error))):(tt_Hide(!0),tip(currSpan,$("#gift_button").data("success"),!0,600,""))}function kanaEl(el,maxlen){"undefined"!=typeof puzzleType&&"kana"!=puzzleType||(inner=$(el).val(),_inner=r2h(inner,!0),distanceFromEnd=inner.length-$(el).caret(),_inner==inner||inner.replace("n","ん")==_inner&&0!=distanceFromEnd&&inner.length==_inner.length&&$(el).is(":focus")||($(el).val(_inner),$(el).is(":focus")&&$(el).caret(Math.max(0,_inner.length-distanceFromEnd))))}function sendDrawing(btn){currentCanvas.erase(),$("#ttip #can_results").html(""),char=$(btn).html(),canvasTarget.is(":visible")||(newTarget=$("#vocab_japanese, #kanji_japanese, #grammar_sval, #sent_jap").filter(":visible"),0<newTarget.length&&(canvasTarget=newTarget,$("#ttip #canvas_ttext").val(canvasTarget.val()))),$("#ttip #canvas_ttext").val($("#ttip #canvas_ttext").val()+char),canvasTarget.val($("#ttip #canvas_ttext").val())}function buildButtons(res,itarget){for(i in box=$(itarget).html(""),res){var charClass="std";res[i].match(/[\u3041-\u3096]/g)?charClass="hira":res[i].match(/[\u30A0-\u30FF]/g)?charClass="kata":res[i].match(/[\u4E00-\u9FAF々]/g)&&(charClass="kanji"),btn=$("<button class='pure-button pure-button-small hsett_"+charClass+"' onclick='sendDrawing(this)'>"+res[i]+"</button>"),box.append(btn)}filterHButtons()}function filterHButtons(update){for(i in allowedTypes=$("#hsett_form").serializeObject(),possibleTypes=["kanji","kata","hira","std"],possibleTypes)$("#ttip #can_results").toggleClass("hide_"+possibleTypes[i],void 0===allowedTypes["hsett[]"]||-1==allowedTypes["hsett[]"].indexOf(possibleTypes[i]));update&&void 0!==allowedTypes["hsett[]"]&&""!=canvasTarget.data("chint-type")&&(prevValue="string"==typeof allowedTypes["hsett[]"]?allowedTypes["hsett[]"]:allowedTypes["hsett[]"].join(","),setPref("chint_"+canvasTarget.data("chint-type"),prevValue))}function keyboardOpen(){var width=$(window).width(),height=$(window).height();return height/width<1.4&&.6<height/width}function searchPictures(pg){opts=$("#pic_search").serializeObject(),void 0!==pg&&(opts.pg=pg),setButton("#psearch_btn",!1),callAjax("misc/picture_ajax",opts,"GET",genPost)}function loadPictures(el,id){tt_Hide(!0),showGeneric(el,"misc/picture_ajax&id="+id+"&action=load")}function ratePicture(pic_id,word_id,rating,lnk){opts={action:"rate",id:word_id,pic_id:pic_id,rating:rating},callAjax("misc/picture_ajax",opts),"useful"==rating?($(lnk).removeClass("lgreen").addClass("green"),$(lnk).next().removeClass("red").addClass("lred")):($(lnk).removeClass("lred").addClass("red"),$(lnk).prev().removeClass("green").addClass("lgreen"))}function prepareCropper(btn,id,long){img=$(btn).parent().parent().find("img"),bigImg=$(img).data("bsrc"),opts={action:"temp",url:bigImg,id:id,long:long},callAjax("misc/picture_ajax",opts,"GET",loadCropper)}function saveDirect(btn,id){img=$(btn).parent().parent().find("img"),$(btn).children().first().removeClass("tlnk").children().addClass("green").off("click"),bigImg=$(img).data("bsrc"),opts={id:id,url:bigImg,action:"save"},callAjax("misc/picture_ajax",opts,"post",saveCropPost)}function saveCrop(btn){opts=$("#pic_cropform").serializeObject(),currentCrop.croppie("result","html").then(function(html){$("#crop_results").html(html),sbox=$("#crop_results").find(".croppie-result"),opts.width=sbox.width(),opts.height=sbox.height(),simg=$("#crop_results").find("img"),opts.left=simg.css("left").replace(/\D/g,""),opts.top=simg.css("top").replace(/\D/g,""),opts.url=$("#crop_img").attr("src"),callAjax("misc/picture_ajax",opts,"post",saveCropPost)})}function saveCropPost(xml){genPost(xml),$("#psearch_crop").hide().prev().show(),$("#pic_search, #pic_current").show()}function loadCropper(xml){data=genPost(xml),$("#psearch_results").hide().next().show(),$("#pic_search, #pic_current").hide(),opts={boundary:{width:data.width,height:data.height},viewport:{width:data.width,height:data.height}},currentCrop=$("#crop_img").croppie(opts)}function newMnemonic(el,id){opts={action:"new",word_id:id},showGeneric(el,"quiz/mn_ajax&"+$.param(opts))}function kamiAjax(el,type,kanji){showGeneric(el,"misc/kami_ajax&type="+type+"&char="+kanji)}function kamiListAjax(el,args){currWorksheet="skanji",showGeneric(el,"misc/kami_list_ajax&"+args)}function makeCrossDirect(cwid,btn){args=$("#dlinks_form_"+cwid).serializeObject(),args.format=$(btn).data("format"),callAjax("misc/kami_back",args,"post",makeKamiPost),setButton(btn,!1)}function previewKami(el,type){args=$(el).parents("form").eq(0).serializeObject(),"skanji"==type?$(el).parents("form").eq(0).find("img").attr("src",getHttp()+"www.renshuu.org/img/kami/"+type+"/"+type+"_A4_"+args.skanji_cross+"_"+args.skanji_trace+"_"+args.skanji_bstyle+".jpg"):"mkanji"==type&&$(el).parents("form").eq(0).find("img").attr("src",getHttp()+"www.renshuu.org/img/kami/"+type+"/"+type+"_A4_"+args.mkanji_cross+"_"+args.mkanji_trace+"_s.jpg")}function showWOpts(type){returnEl(currWorksheet+"_ibox").removeClass("str striped sel"),hde(currWorksheet+"_opts"),shw(type+"_opts"),returnEl(type+"_ibox").addClass("str striped sel"),currWorksheet=type}function massPLoad(){$.each($(".presults_box"),function(){$(this).bind("inview",function(event,isInView,visiblePartX,visiblePartY){isInView&&"1"!=$(this).data("loaded")&&($(this).data("loaded","1"),opts={id:$(this).data("id"),action:"search",query:$(this).data("search"),source:"pixabay",perpage:20,crop:0},callAjax("misc/picture_ajax",opts,"GET",genPost))})})}function editMnemonic(el,id,kid){showGeneric(el,"quiz/mn_ajax&mn_id="+id+"&action=edit&word_id="+kid)}function deleteMnemonic(el,id){_confirm($(el).data("confirm"),function(){opts={action:"delete",mn_id:id},callAjax("quiz/mn_ajax",opts,"POST"),$("#mnbox_"+id).remove()})}function rateMnemonic(sid,rate,el){callAjax("quiz/mn_ajax&action=rate&mn_id="+sid+"&rate="+rate),"useful"==rate?($("#museful_"+sid).find("i").addClass("like_mark green").removeClass("lgreen"),$("#museless_"+sid).find("i").removeClass("like_mark red").addClass("lred")):($("#museful_"+sid).find("i").removeClass("like_mark green").addClass("lgreen"),$("#museless_"+sid).find("i").addClass("like_mark red").removeClass("lred"))}function sendUMessage(bid){frm=$("#send_reply_"+bid),args=frm.serializeObject(),""==args.comment?alertBox($("#add_message_error_"+bid).data("empty"),!0,"add_message_error_"+bid):(hde("add_message_error_"+bid),setButton("#add_message_submit_"+bid,!1),callAjax("user/messages_alter",args,"post",sendUMessagePost))}function sendUMessagePost(jsonarr){jsonarr=preProcessJSON(jsonarr);setButton("#add_message_submit_"+jsonarr.bid,!0),jsonarr.error?alertBox(jsonarr.error,!0,"add_message_error_"+jsonarr.bid):($R("#add_message_"+jsonarr.bid,"destroy"),$("#add_message_"+jsonarr.bid).val(""),buildRedactor("add_message_"+jsonarr.bid),$("#buffbox").html(jsonarr.result),$("#buffbox").children().insertBefore($("#send_reply_"+jsonarr.bid)),$("#message_count_"+jsonarr.bid).html(parseInt($("#message_count_"+jsonarr.bid).html())+1),restripe("message_"+jsonarr.bid,$("#message_"+jsonarr.bid+"_full").hasClass("striped")))}function saveMSettings(){frm=$("#message_settings"),args=frm.serializeObject(),$("#messagebox").show(),$("#settingsbox").hide(),callAjax("user/messages_alter",args,"post")}function alterMessages(type){$("#message_checkall").attr({checked:!1});var mids=[];if($.each($("#um_body").find('input[type="checkbox"]'),function(i,s){"checked"!=s.checked&&1!=s.checked||mids.push(s.value)}),0==mids.length)return _alert("You need to check one or more messages/alerts."),!1;$("#message_ids").val(mids.join(",")),frm=$("#messages_alter"),args=frm.serializeObject(),args[type]=1,args.pg=_page,shw("um_wait"),hde("um_body"),callAjax("user/messages_alter",args,"post",alterMessagesPost),$("#um_body").empty(),inboxButtons()}function alterMessagesPost(xml){jsonarr=preProcessJSON(xml),adjustInboxNumbers(jsonarr.ncount),genPost(xml)}function localSettingsSave(){postArr=$("#lsettings_form").serializeObject(),shw("lsettings_save"),hde("lsettings_body"),$("#overlay").show(),$("#settings_close_btn").click(),callAjax("user/lsettings&saveprefs=1",postArr,"post",localSettingsSavePost)}function localSettingsSavePost(xml){preProcessJSON(xml).reload?window.location.reload():($("#overlay").hide(),genPost(xml),$("#sett_bodies").css({height:$("#lsetbox").height()-$("#lsettings_head").height()-10+"px"}))}function localSettingsShift(el){$(el).is(":checked")?($.each($("#lsetbox").find('[class~="set_adv"]'),function(index,s){shw(s)}),hde($(".sett_bodies #sett_adv")),hde("sett_adv"),shw($(".sett_bodies #sett_simple")),shw("sett_simple"),setPref("adv_settings","yes")):($.each($("#lsetbox").find('[class~="set_adv"]'),function(index,s){hde(s)}),shw("sett_adv"),shw($(".sett_bodies #sett_adv")),hde("sett_simple"),hde($(".sett_bodies #sett_simple")),setPref("adv_settings","no"))}function radTable(show,sfx,immed){void 0===sfx&&(sfx=""),show?(shw("rad_hide"+sfx),hde("rad_show"+sfx),$("#rad_table"+sfx).slideDown()):(shw("rad_show"+sfx),hde("rad_hide"+sfx),$("#rad_table"+sfx).slideUp(1==immed?0:400))}function radTableClick(id,force){1==$("#rad_table_"+id).prop("checked")||force?($("#rad_table_"+id).next().removeClass("green bolded"),$("#rad_table_"+id).next().addClass("grey"),$("#rad_table_"+id).prop("checked",!1)):($("#rad_table_"+id).prop("checked",!0),$("#rad_table_"+id).next().addClass("green bolded"),$("#rad_table_"+id).next().removeClass("grey"))}function radTableClear(){$.each($("div.radTableClick").find("input"),function(){radTableClick($(this).val(),!0)})}function displayMessage(bid,title,hide){messageBoxes[bid]?($("#message_"+bid+"_full").removeClass("msg_open"),$("#message_"+bid).slideUp()):($("#message_"+bid+"_full").addClass("msg_open"),$("#message_"+bid).slideDown()),messageBoxes[bid]=!messageBoxes[bid],1==hide&&$(title).parent().hasClass("bold")&&($(title).parent().removeClass("bold"),hideNews("pm&id="+bid,!1))}function loadUMs(page){$("#um_body").html(loader(_lang.status_loading)),_page=page,callAjax("user/messages_uback&pg="+page,!1,!1,genPost)}function loadKWords(page,kid,reading,limit){opts={kid:kid,reading:0!=reading?reading:"",pg:page,limit:limit?1:0},callAjax("quiz/ext_kwords",opts,!1,genPost),$("#kwords_"+kid).html(loader(_lang.status_loading))}function loadDKWords(page,kanji,reading,el){target=$(el).parents(".tabbody, #kdict_rwords").first(),opts={reading:reading,pg:page,target:target.attr("id")},$(target).height($(target).height()).html(loader(_lang.status_loading)),sendLookupKanji(kanji,!1,!0,opts)}function masteryDefaults(){for(x=2;x<=9;x++)$("#mastery_l"+x).val(mDefs[x]),$("#lmastery_l"+x).html(mDefs[x])}function getReibuns(suffix,search,offset){search||(search=$("#reibun_search_"+suffix).val(),offset=0);var esearch=$("#reibun_esearch_"+suffix)?$("#reibun_esearch_"+suffix).val():"";shw("suggest_reibuns_"+suffix),$("#suggest_reibuns_"+suffix).html(' <span class="red">'+_lang.status_loading+"</span>"),callAjax("misc/ext_reibun_search&search="+search+"&offset="+offset+"&meaning_id="+suffix+"&esearch="+esearch,!1,!1,genPost)}function readingPop(el,reading,type,kanji,id,elid,curron){void 0===curron&&(curron=""),known=!(returnEl(el).parents("span")&&returnEl(el).parents("span").hasClass("grey")||returnEl(el).hasClass("grey")),tt_Hide(!0),hooktip(el,reading+"<br/><br/><span class='tlnk' onclick=\"tt_Hide(true); dJ('k','r="+reading+"');\">"+_lang.lookup_reading+"</span><br/><input type='checkbox' "+(known?"checked=checked":"")+" onchange=\"readingPopSend('"+reading+"',"+id+",this,'"+elid+"','"+curron+"')\"/> "+_lang.known_reading)}function readingPopSend(reading,id,checkbox,elid,curron){known=1==returnEl(checkbox).prop("checked")?"yes":"no","yes"==known?$("#read_"+id+"_"+elid).removeClass("grey sunknown"):$("#read_"+id+"_"+elid).addClass("grey sunknown"),args={kid:id,reading:reading,known:known,curron:curron},callAjax("misc/ext_altreading",args,"post",readingPopSendPost),"undefined"!=typeof sched_altered&&(sched_altered=!0)}function readingPopSendPost(xml){void 0!==preProcessJSON(xml).reloadQuiz&&"undefined"!=typeof inquizOpts&&jumpUrl("index.php?page=quiz/run_quiz")}function toggleAll(parent,iname,checked){inputs=returnEl(parent).find('input[type="checkbox"]'),$.each(inputs,function(index,s){s.checked=checked?"checked":""})}function adjustWidget(chk,wid){opts={widget_id:wid,action:"widget",waction:$(chk).is(":checked")?"add":"remove"},callAjax("user/me_back",opts)}function postManga(xml){data=genPost(xml),mangaLB=SimpleLightbox.open({items:data.manga_cards.split(","),captions:data.manga_captions.split(",,"),startAt:parseInt(data.start),nextBtnClass:" blackBtn",prevBtnClass:" blackBtn"}),data.manga_next&&($("#manga_level").html(data.start),$("#manga_preview").html(data.manga_preview),$("#manga_next").show().html(data.manga_next))}function loadManga(page){opts={start:page},callAjax("user/manga",opts,"get",postManga)}function kaolightBox(kao_id){args={kao_id:kao_id,action:"kaos_list"},callAjax("user/me_back",args,"POST",kaolightBoxPost)}jQuery.fn.caret=function(pos){var target=this[0],isContentEditable="true"===target.contentEditable;if(0!=arguments.length)return-1==pos&&(pos=this[isContentEditable?"text":"val"]().length),window.getSelection?isContentEditable?(target.focus(),window.getSelection().collapse(target.firstChild,pos)):target.setSelectionRange(pos,pos):document.body.createTextRange&&(isContentEditable?((range=document.body.createTextRange()).moveToElementText(target),range.moveStart("character",pos),range.collapse(!0)):(range=target.createTextRange()).move("character",pos),range.select()),isContentEditable||target.focus(),this;if(window.getSelection)return isContentEditable?(target.focus(),(bookmark=(range1=window.getSelection().getRangeAt(0)).cloneRange()).selectNodeContents(target),bookmark.setEnd(range1.endContainer,range1.endOffset),bookmark.toString().length):target.selectionStart;if(document.selection){if(target.focus(),isContentEditable){var range1=document.selection.createRange();return(bookmark=document.body.createTextRange()).moveToElementText(target),bookmark.setEndPoint("EndToEnd",range1),bookmark.text.length}var pos=0,range=target.createTextRange(),bookmark=(bookmark=document.selection.createRange().duplicate()).getBookmark();for(range.moveToBookmark(bookmark);0!==range.moveStart("character",-1);)pos++;return pos}return target.selectionStart||0},function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof exports&&"string"!=typeof exports.nodeName?module.exports=t():e.Croppie=t()}("undefined"!=typeof self?self:this,function(){"function"!=typeof Promise&&function(e){function n(e,t){return function(){e.apply(t,arguments)}}function r(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],u(e,n(i,this),n(o,this))}function a(n){var i=this;return null===this._state?void this._deferreds.push(n):void c(function(){var t,e=i._state?n.onFulfilled:n.onRejected;if(null!==e){try{t=e(i._value)}catch(e){return void n.reject(e)}n.resolve(t)}else(i._state?n.resolve:n.reject)(i._value)})}function i(e){try{if(e===this)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var t=e.then;if("function"==typeof t)return void u(n(t,e),n(i,this),n(o,this))}this._state=!0,this._value=e,s.call(this)}catch(e){o.call(this,e)}}function o(e){this._state=!1,this._value=e,s.call(this)}function s(){for(var e=0,t=this._deferreds.length;e<t;e++)a.call(this,this._deferreds[e]);this._deferreds=null}function l(e,t,n,i){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=i}function u(e,t,n){var i=!1;try{e(function(e){i||(i=!0,t(e))},function(e){i||(i=!0,n(e))})}catch(e){if(i)return;i=!0,n(e)}}var t=setTimeout,c="function"==typeof setImmediate&&setImmediate||function(e){t(e,1)},h=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};r.prototype.catch=function(e){return this.then(null,e)},r.prototype.then=function(n,i){var o=this;return new r(function(e,t){a.call(o,new l(n,i,e,t))})},r.all=function(){var s=Array.prototype.slice.call(1===arguments.length&&h(arguments[0])?arguments[0]:arguments);return new r(function(i,o){if(0===s.length)return i([]);for(var a=s.length,e=0;e<s.length;e++)!function r(t,e){try{if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if("function"==typeof n)return n.call(e,function(e){r(t,e)},o),0}s[t]=e,0==--a&&i(s)}catch(e){o(e)}}(e,s[e])})},r.resolve=function(t){return t&&"object"==typeof t&&t.constructor===r?t:new r(function(e){e(t)})},r.reject=function(n){return new r(function(e,t){t(n)})},r.race=function(o){return new r(function(e,t){for(var n=0,i=o.length;n<i;n++)o[n].then(e,t)})},r._setImmediateFn=function(e){c=e},"undefined"!=typeof module&&module.exports?module.exports=r:e.Promise||(e.Promise=r)}(this),"function"!=typeof window.CustomEvent&&function(){function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}e.prototype=window.Event.prototype,window.CustomEvent=e}(),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,n){for(var i=atob(this.toDataURL(t,n).split(",")[1]),o=i.length,r=new Uint8Array(o),a=0;a<o;a++)r[a]=i.charCodeAt(a);e(new Blob([r],{type:t||"image/png"}))}});var i=["Webkit","Moz","ms"],o=document.createElement("div").style,l=[1,8,3,6],u=[2,7,4,5];function e(e){if(e in o)return e;for(var t=e[0].toUpperCase()+e.slice(1),n=i.length;n--;)if((e=i[n]+t)in o)return e}function p(e,t){for(var n in e=e||{},t)t[n]&&t[n].constructor&&t[n].constructor===Object?(e[n]=e[n]||{},p(e[n],t[n])):e[n]=t[n];return e}function d(e){return p({},e)}function y(e){var t;"createEvent"in document?((t=document.createEvent("HTMLEvents")).initEvent("change",!1,!0),e.dispatchEvent(t)):e.fireEvent("onchange")}function b(e,t,n){var i,o;for(o in"string"==typeof t&&(i=t,(t={})[i]=n),t)e.style[o]=t[o]}function x(e,t){e.classList?e.classList.add(t):e.className+=" "+t}function c(e,t){for(var n in t)e.setAttribute(n,t[n])}function C(e){return parseInt(e,10)}function m(r,t){var n=r.naturalWidth,i=r.naturalHeight,r=t||f(r);return r&&5<=r&&(r=n,n=i,i=r),{width:n,height:i}}var g=e("transform"),v=e("transformOrigin"),w=e("userSelect"),t={translate3d:{suffix:", 0px"},translate:{suffix:""}},E=function(e,t,n){this.x=parseFloat(e),this.y=parseFloat(t),this.scale=parseFloat(n)};E.parse=function(e){return e.style?E.parse(e.style[g]):-1<e.indexOf("matrix")||-1<e.indexOf("none")?E.fromMatrix(e):E.fromString(e)},E.fromMatrix=function(e){var t=e.substring(7).split(",");return t.length&&"none"!==e||(t=[1,0,0,1,0,0]),new E(C(t[4]),C(t[5]),parseFloat(t[0]))},E.fromString=function(i){var o=i.split(") "),r=o[0].substring(T.globals.translate.length+1).split(","),i=1<o.length?o[1].substring(6):1,o=1<r.length?r[0]:0,r=1<r.length?r[1]:0;return new E(o,r,i)},E.prototype.toString=function(){var e=t[T.globals.translate].suffix||"";return T.globals.translate+"("+this.x+"px, "+this.y+"px"+e+") scale("+this.scale+")"};var L=function(t){if(!t||!t.style[v])return this.x=0,void(this.y=0);t=t.style[v].split(" ");this.x=parseFloat(t[0]),this.y=parseFloat(t[1])};function f(e){return e.exifdata&&e.exifdata.Orientation?C(e.exifdata.Orientation):1}function _(e,t,n){var i=t.width,o=t.height,r=e.getContext("2d");switch(e.width=t.width,e.height=t.height,r.save(),n){case 2:r.translate(i,0),r.scale(-1,1);break;case 3:r.translate(i,o),r.rotate(180*Math.PI/180);break;case 4:r.translate(0,o),r.scale(1,-1);break;case 5:e.width=o,e.height=i,r.rotate(90*Math.PI/180),r.scale(1,-1);break;case 6:e.width=o,e.height=i,r.rotate(90*Math.PI/180),r.translate(0,-o);break;case 7:e.width=o,e.height=i,r.rotate(-90*Math.PI/180),r.translate(-i,o),r.scale(1,-1);break;case 8:e.width=o,e.height=i,r.translate(0,i),r.rotate(-90*Math.PI/180)}r.drawImage(t,0,0,i,o),r.restore()}function R(){return this.options.enableExif&&window.EXIF}function B(n){var t;this.options.enableZoom&&(t=this.elements.zoomer,n=A(n,4),t.value=Math.max(parseFloat(t.min),Math.min(parseFloat(t.max),n)).toString())}function Z(m){var h,t=this,n=t._currentZoom,p=t.elements.preview.getBoundingClientRect(),d=t.elements.viewport.getBoundingClientRect(),r=E.parse(t.elements.preview.style[g]),a=new L(t.elements.preview),s=d.top-p.top+d.height/2,l=d.left-p.left+d.width/2,u={},f={};m?(h=a.x,p=a.y,d=r.x,m=r.y,u.y=h,u.x=p,r.y=d,r.x=m):(u.y=s/n,u.x=l/n,f.y=(u.y-a.y)*(1-n),f.x=(u.x-a.x)*(1-n),r.x-=f.x,r.y-=f.y);f={};f[v]=u.x+"px "+u.y+"px",f[g]=r.toString(),b(t.elements.preview,f)}function z(){var e,t;this.elements&&(e=this.elements.boundary.getBoundingClientRect(),t=this.elements.preview.getBoundingClientRect(),b(this.elements.overlay,{width:t.width+"px",height:t.height+"px",top:t.top-e.top+"px",left:t.left-e.left+"px"}))}L.prototype.toString=function(){return this.x+"px "+this.y+"px"};var a,M,I=(a=z,function(){var e=this,t=arguments;clearTimeout(M),M=setTimeout(function(){M=null,a.apply(e,t)},500)});function F(){var e,t=this,n=t.get();X.call(t)&&(t.options.update.call(t,n),t.$&&"undefined"==typeof Prototype?t.$(t.element).trigger("update.croppie",n):(window.CustomEvent?e=new CustomEvent("update",{detail:n}):(e=document.createEvent("CustomEvent")).initCustomEvent("update",!0,!0,n),t.element.dispatchEvent(e)))}function X(){return 0<this.elements.preview.offsetHeight&&0<this.elements.preview.offsetWidth}function Y(){var t=this,n={},i=t.elements.preview,o=new E(0,0,1),e=new L;X.call(t)&&!t.data.bound&&(t.data.bound=!0,n[g]=o.toString(),n[v]=e.toString(),n.opacity=1,b(i,n),e=t.elements.preview.getBoundingClientRect(),t._originalImageWidth=e.width,t._originalImageHeight=e.height,t.data.orientation=f(t.elements.img),t.options.enableZoom?W.call(t,!0):t._currentZoom=1,o.scale=t._currentZoom,n[g]=o.toString(),b(i,n),t.data.points.length?function(c){if(4!==c.length)throw"Croppie - Invalid number of points supplied: "+c;var t=this,l=c[2]-c[0],s=t.elements.viewport.getBoundingClientRect(),a=t.elements.boundary.getBoundingClientRect(),h=s.left-a.left,u=s.top-a.top,a=s.width/l,s=c[1],l=c[0],u=-1*c[1]+u,c=-1*c[0]+h,h={};h[v]=l+"px "+s+"px",h[g]=new E(c,u,a).toString(),b(t.elements.preview,h),B.call(t,a),t._currentZoom=a}.call(t,t.data.points):function(){var e=this,t=e.elements.preview.getBoundingClientRect(),l=e.elements.viewport.getBoundingClientRect(),r=e.elements.boundary.getBoundingClientRect(),a=l.left-r.left,r=l.top-r.top,a=a-(t.width-l.width)/2,l=r-(t.height-l.height)/2,l=new E(a,l,e._currentZoom);b(e.elements.preview,g,l.toString())}.call(t),Z.call(t),z.call(t))}function W(e){var i,r=this,a=Math.max(r.options.minZoom,0)||0,s=r.options.maxZoom||1.5,l=r.elements.zoomer,u=parseFloat(l.value),c=r.elements.boundary.getBoundingClientRect(),t=m(r.elements.img,r.data.orientation),o=r.elements.viewport.getBoundingClientRect();r.options.enforceBoundary&&(i=o.width/t.width,o=o.height/t.height,a=Math.max(i,o)),s<=a&&(s=a+1),l.min=A(a,4),l.max=A(s,4),!e&&(u<l.min||u>l.max)?B.call(r,u<l.min?l.min:l.max):e&&(t=Math.max(c.width/t.width,c.height/t.height),t=null!==r.data.boundZoom?r.data.boundZoom:t,B.call(r,t)),y(l)}function O(w){var g=w.points,n=C(g[0]),i=C(g[1]),o=C(g[2])-n,r=C(g[3])-i,a=w.circle,s=document.createElement("canvas"),l=s.getContext("2d"),u=w.outputWidth||o,c=w.outputHeight||r;s.width=u,s.height=c,w.backgroundColor&&(l.fillStyle=w.backgroundColor,l.fillRect(0,0,u,c));var h=n,p=i,d=o,m=r,f=0,v=0,g=u,w=c;return n<0&&(h=0,f=Math.abs(n)/o*u),d+h>this._originalImageWidth&&(g=(d=this._originalImageWidth-h)/o*u),i<0&&(p=0,v=Math.abs(i)/r*c),m+p>this._originalImageHeight&&(w=(m=this._originalImageHeight-p)/r*c),l.drawImage(this.elements.preview,h,p,d,m,f,v,g,w),a&&(l.fillStyle="#fff",l.globalCompositeOperation="destination-in",l.beginPath(),l.arc(s.width/2,s.height/2,s.width/2,0,2*Math.PI,!0),l.closePath(),l.fill()),s}function k(c,h){var e,i,o,r,p=this,d=[],t=null,n=R.call(p);if("string"==typeof c)e=c,c={};else if(Array.isArray(c))d=c.slice();else{if(void 0===c&&p.data.url)return Y.call(p),F.call(p),null;e=c.url,d=c.points||[],t=void 0===c.zoom?null:c.zoom}return p.data.bound=!1,p.data.url=e||p.data.url,p.data.boundZoom=t,i=e,o=n,(r=new Image).style.opacity="0",new Promise(function(e,t){function n(){r.style.opacity="1",setTimeout(function(){e(r)},1)}r.removeAttribute("crossOrigin"),i.match(/^https?:\/\/|^\/\//)&&r.setAttribute("crossOrigin","anonymous"),r.onload=function(){o?EXIF.getData(r,function(){n()}):n()},r.onerror=function(e){r.style.opacity=1,setTimeout(function(){t(e)},1)},r.src=i}).then(function(a){var t,n,s;(function(t){this.elements.img.parentNode&&(Array.prototype.forEach.call(this.elements.img.classList,function(e){t.classList.add(e)}),this.elements.img.parentNode.replaceChild(t,this.elements.img),this.elements.preview=t),this.elements.img=t}).call(p,a),d.length?p.options.relative&&(d=[d[0]*a.naturalWidth/100,d[1]*a.naturalHeight/100,d[2]*a.naturalWidth/100,d[3]*a.naturalHeight/100]):(s=m(a),(a=(a=p.elements.viewport.getBoundingClientRect()).width/a.height)<s.width/s.height?t=(n=s.height)*a:(t=s.width,n=s.height/a),a=(s.width-t)/2,s=(s.height-n)/2,p.data.points=[a,s,a+t,s+n]),p.data.points=d.map(function(e){return parseFloat(e)}),p.options.useCanvas&&function(e){var t=this.elements.canvas,n=this.elements.img;t.getContext("2d").clearRect(0,0,t.width,t.height),t.width=n.width,t.height=n.height,_(t,n,this.options.enableOrientation&&e||f(n))}.call(p,c.orientation),Y.call(p),F.call(p),h&&h()})}function A(e,t){return parseFloat(e).toFixed(t||0)}function j(){var e=this,s=e.elements.preview.getBoundingClientRect(),l=e.elements.viewport.getBoundingClientRect(),i=l.left-s.left,o=l.top-s.top,u=(l.width-e.elements.viewport.offsetWidth)/2,c=(l.height-e.elements.viewport.offsetHeight)/2,s=i+e.elements.viewport.offsetWidth+u,l=o+e.elements.viewport.offsetHeight+c,u=e._currentZoom;u!==1/0&&!isNaN(u)||(u=1);c=e.options.enforceBoundary?0:Number.NEGATIVE_INFINITY,i=Math.max(c,i/u),o=Math.max(c,o/u),s=Math.max(c,s/u),l=Math.max(c,l/u);return{points:[A(i),A(o),A(s),A(l)],zoom:u,orientation:e.data.orientation}}var P,H={type:"canvas",format:"png",quality:1},N=["jpeg","webp","png"];function T(e,i){if(-1<e.className.indexOf("croppie-container"))throw new Error("Croppie: Can't initialize croppie more than once");var o;this.element=e,this.options=p(d(T.defaults),i),"img"===this.element.tagName.toLowerCase()&&(x(o=this.element,"cr-original-image"),c(o,{"aria-hidden":"true",alt:""}),i=document.createElement("div"),this.element.parentNode.appendChild(i),i.appendChild(o),this.element=i,this.options.url=this.options.url||o.src),function(){var e,n,i,o,r,a=this,s=a.options.viewport.type?"cr-vp-"+a.options.viewport.type:null;a.options.useCanvas=a.options.enableOrientation||R.call(a),a.data={},a.elements={},e=a.elements.boundary=document.createElement("div"),n=a.elements.viewport=document.createElement("div"),r=a.elements.img=document.createElement("img"),i=a.elements.overlay=document.createElement("div"),a.options.useCanvas?(a.elements.canvas=document.createElement("canvas"),a.elements.preview=a.elements.canvas):a.elements.preview=r,x(e,"cr-boundary"),e.setAttribute("aria-dropeffect","none"),o=a.options.boundary.width,r=a.options.boundary.height,b(e,{width:o+(isNaN(o)?"":"px"),height:r+(isNaN(r)?"":"px")}),x(n,"cr-viewport"),s&&x(n,s),b(n,{width:a.options.viewport.width+"px",height:a.options.viewport.height+"px"}),n.setAttribute("tabindex",0),x(a.elements.preview,"cr-image"),c(a.elements.preview,{alt:"preview","aria-grabbed":"false"}),x(i,"cr-overlay"),a.element.appendChild(e),e.appendChild(a.elements.preview),e.appendChild(n),e.appendChild(i),x(a.element,"croppie-container"),a.options.customClass&&x(a.element,a.options.customClass),function(){var h,p,d,l,m,f=this,n=!1;function v(e,t){var n=f.elements.preview.getBoundingClientRect(),i=m.y+t,o=m.x+e;f.options.enforceBoundary?(l.top>n.top+t&&l.bottom<n.bottom+t&&(m.y=i),l.left>n.left+e&&l.right<n.right+e&&(m.x=o)):(m.y=i,m.x=o)}function i(e){f.elements.preview.setAttribute("aria-grabbed",e),f.elements.boundary.setAttribute("aria-dropeffect",e?"move":"none")}function e(t){void 0!==t.button&&0!==t.button||(t.preventDefault(),n)||(n=!0,h=t.pageX,p=t.pageY,t.touches&&(t=t.touches[0],h=t.pageX,p=t.pageY),i(n),m=E.parse(f.elements.preview),window.addEventListener("mousemove",o),window.addEventListener("touchmove",o),window.addEventListener("mouseup",r),window.addEventListener("touchend",r),document.body.style[w]="none",l=f.elements.viewport.getBoundingClientRect())}function o(u){u.preventDefault();var t=u.pageX,n=u.pageY;u.touches&&(t=(s=u.touches[0]).pageX,n=s.pageY);var o=t-h,r=n-p,a={};if("touchmove"===u.type&&1<u.touches.length){var s=u.touches[0],u=u.touches[1],u=Math.sqrt((s.pageX-u.pageX)*(s.pageX-u.pageX)+(s.pageY-u.pageY)*(s.pageY-u.pageY));return d=d||u/f._currentZoom,B.call(f,u/d),void y(f.elements.zoomer)}v(o,r),a[g]=m.toString(),b(f.elements.preview,a),z.call(f),p=n,h=t}function r(){i(n=!1),window.removeEventListener("mousemove",o),window.removeEventListener("touchmove",o),window.removeEventListener("mouseup",r),window.removeEventListener("touchend",r),document.body.style[w]="",Z.call(f),F.call(f),d=0}f.elements.overlay.addEventListener("mousedown",e),f.elements.viewport.addEventListener("keydown",function(n){var t,a;!n.shiftKey||38!==n.keyCode&&40!==n.keyCode?f.options.enableKeyMovement&&37<=n.keyCode&&n.keyCode<=40&&(n.preventDefault(),t=function(e){switch(e){case 37:return[1,0];case 38:return[0,1];case 39:return[-1,0];case 40:return[0,-1]}}(n.keyCode),m=E.parse(f.elements.preview),document.body.style[w]="none",l=f.elements.viewport.getBoundingClientRect(),a={},v(t[0],t[1]),a[g]=m.toString(),b(f.elements.preview,a),z.call(f),document.body.style[w]="",Z.call(f),F.call(f),d=0):(n=38===n.keyCode?parseFloat(f.elements.zoomer.value)+parseFloat(f.elements.zoomer.step):parseFloat(f.elements.zoomer.value)-parseFloat(f.elements.zoomer.step),f.setZoom(n))}),f.elements.overlay.addEventListener("touchstart",e)}.call(this),a.options.enableZoom&&function(){var i=this,e=i.elements.zoomerWrap=document.createElement("div"),t=i.elements.zoomer=document.createElement("input");function o(){!function(l){var t=this,n=l?l.transform:E.parse(t.elements.preview),s=l?l.viewportRect:t.elements.viewport.getBoundingClientRect(),o=l?l.origin:new L(t.elements.preview);function r(){var e={};e[g]=n.toString(),e[v]=o.toString(),b(t.elements.preview,e)}t._currentZoom=l?l.value:t._currentZoom,n.scale=t._currentZoom,t.elements.zoomer.setAttribute("aria-valuenow",t._currentZoom),r(),t.options.enforceBoundary&&(s=(l=function(d){var t=this._currentZoom,n=d.width,i=d.height,h=this.elements.boundary.clientWidth/2,p=this.elements.boundary.clientHeight/2,m=this.elements.preview.getBoundingClientRect(),s=m.width,l=m.height,d=n/2,m=i/2,h=-1*(d/t-h),p=-1*(m/t-p),d=1/t*d,m=1/t*m;return{translate:{maxX:h,minX:h-(s*(1/t)-n*(1/t)),maxY:p,minY:p-(l*(1/t)-i*(1/t))},origin:{maxX:s*(1/t)-d,minX:d,maxY:l*(1/t)-m,minY:m}}}.call(t,s)).translate,l=l.origin,n.x>=s.maxX&&(o.x=l.minX,n.x=s.maxX),n.x<=s.minX&&(o.x=l.maxX,n.x=s.minX),n.y>=s.maxY&&(o.y=l.minY,n.y=s.maxY),n.y<=s.minY&&(o.y=l.maxY,n.y=s.minY)),r(),I.call(t),F.call(t)}.call(i,{value:parseFloat(t.value),origin:new L(i.elements.preview),viewportRect:i.elements.viewport.getBoundingClientRect(),transform:E.parse(i.elements.preview)})}function n(e){var n;if("ctrl"===i.options.mouseWheelZoom&&!0!==e.ctrlKey)return 0;n=e.wheelDelta?e.wheelDelta/1200:e.deltaY?e.deltaY/1060:e.detail?e.detail/-60:0,n=i._currentZoom+n*i._currentZoom,e.preventDefault(),B.call(i,n),o.call(i)}x(e,"cr-slider-wrap"),x(t,"cr-slider"),t.type="range",t.step="0.0001",t.value="1",t.style.display=i.options.showZoomer?"":"none",t.setAttribute("aria-label","zoom"),i.element.appendChild(e),e.appendChild(t),i._currentZoom=1,i.elements.zoomer.addEventListener("input",o),i.elements.zoomer.addEventListener("change",o),i.options.mouseWheelZoom&&(i.elements.boundary.addEventListener("mousewheel",n),i.elements.boundary.addEventListener("DOMMouseScroll",n))}.call(a),a.options.enableResize&&function(){var l,u,c,h,p,e,t,d=this,m=document.createElement("div"),i=!1,f=50;function n(n){var t;void 0!==n.button&&0!==n.button||(n.preventDefault(),i)||(t=d.elements.overlay.getBoundingClientRect(),i=!0,u=n.pageX,c=n.pageY,l=-1!==n.currentTarget.className.indexOf("vertical")?"v":"h",h=t.width,p=t.height,n.touches&&(n=n.touches[0],u=n.pageX,c=n.pageY),window.addEventListener("mousemove",o),window.addEventListener("touchmove",o),window.addEventListener("mouseup",r),window.addEventListener("touchend",r),document.body.style[w]="none")}function o(a){var t=a.pageX,n=a.pageY;a.preventDefault(),a.touches&&(t=(s=a.touches[0]).pageX,n=s.pageY);var o=t-u,r=n-c,a=d.options.viewport.height+r,s=d.options.viewport.width+o;"v"===l&&f<=a&&a<=p?(b(m,{height:a+"px"}),d.options.boundary.height+=r,b(d.elements.boundary,{height:d.options.boundary.height+"px"}),d.options.viewport.height+=r,b(d.elements.viewport,{height:d.options.viewport.height+"px"})):"h"===l&&f<=s&&s<=h&&(b(m,{width:s+"px"}),d.options.boundary.width+=o,b(d.elements.boundary,{width:d.options.boundary.width+"px"}),d.options.viewport.width+=o,b(d.elements.viewport,{width:d.options.viewport.width+"px"})),z.call(d),W.call(d),Z.call(d),F.call(d),c=n,u=t}function r(){i=!1,window.removeEventListener("mousemove",o),window.removeEventListener("touchmove",o),window.removeEventListener("mouseup",r),window.removeEventListener("touchend",r),document.body.style[w]=""}x(m,"cr-resizer"),b(m,{width:this.options.viewport.width+"px",height:this.options.viewport.height+"px"}),this.options.resizeControls.height&&(x(e=document.createElement("div"),"cr-resizer-vertical"),m.appendChild(e)),this.options.resizeControls.width&&(x(t=document.createElement("div"),"cr-resizer-horisontal"),m.appendChild(t)),e&&(e.addEventListener("mousedown",n),e.addEventListener("touchstart",n)),t&&(t.addEventListener("mousedown",n),t.addEventListener("touchstart",n)),this.elements.boundary.appendChild(m)}.call(a)}.call(this),this.options.url&&(o={url:this.options.url,points:this.options.points},delete this.options.url,delete this.options.points,k.call(this,o))}return window.jQuery&&((P=window.jQuery).fn.croppie=function(n){if("string"!=typeof n)return this.each(function(){var e=new T(this,n);(e.$=P)(this).data("croppie",e)});var i=Array.prototype.slice.call(arguments,1),e=P(this).data("croppie");return"get"===n?e.get():"result"===n?e.result.apply(e,i):"bind"===n?e.bind.apply(e,i):this.each(function(){var e=P(this).data("croppie");if(e){var t=e[n];if(!P.isFunction(t))throw"Croppie "+n+" method not found";t.apply(e,i),"destroy"===n&&P(this).removeData("croppie")}})}),T.defaults={viewport:{width:100,height:100,type:"square"},boundary:{},orientationControls:{enabled:!0,leftClass:"",rightClass:""},resizeControls:{width:!0,height:!0},customClass:"",showZoomer:!0,enableZoom:!0,enableResize:!1,mouseWheelZoom:!0,enableExif:!1,enforceBoundary:!0,enableOrientation:!1,enableKeyMovement:!0,update:function(){}},T.globals={translate:"translate3d"},p(T.prototype,{bind:function(e,t){return k.call(this,e,t)},get:function(){var e=j.call(this),t=e.points;return this.options.relative&&(t[0]/=this.elements.img.naturalWidth/100,t[1]/=this.elements.img.naturalHeight/100,t[2]/=this.elements.img.naturalWidth/100,t[3]/=this.elements.img.naturalHeight/100),e},result:function(e){return function(c){var t=this,n=j.call(t),h=p(d(H),d(c)),o="string"==typeof c?c:h.type||"base64",r=h.size||"viewport",a=h.format,s=h.quality,l=h.backgroundColor,u="boolean"==typeof h.circle?h.circle:"circle"===t.options.viewport.type,h=(c=t.elements.viewport.getBoundingClientRect()).width/c.height;return"viewport"===r?(n.outputWidth=c.width,n.outputHeight=c.height):"object"==typeof r&&(r.width&&r.height?(n.outputWidth=r.width,n.outputHeight=r.height):r.width?(n.outputWidth=r.width,n.outputHeight=r.width/h):r.height&&(n.outputWidth=r.height*h,n.outputHeight=r.height)),-1<N.indexOf(a)&&(n.format="image/"+a,n.quality=s),n.circle=u,n.url=t.data.url,n.backgroundColor=l,new Promise(function(e){switch(o.toLowerCase()){case"rawcanvas":e(O.call(t,n));break;case"canvas":case"base64":e(function(e){return O.call(this,e).toDataURL(e.format,e.quality)}.call(t,n));break;case"blob":!function(e){var n=this;return new Promise(function(t){O.call(n,e).toBlob(function(e){t(e)},e.format,e.quality)})}.call(t,n).then(e);break;default:e(function(e){var t=e.points,n=document.createElement("div"),i=document.createElement("img"),o=t[2]-t[0],r=t[3]-t[1];return x(n,"croppie-result"),n.appendChild(i),b(i,{left:-1*t[0]+"px",top:-1*t[1]+"px"}),i.src=e.url,b(n,{width:o+"px",height:r+"px"}),n}.call(t,n))}})}.call(this,e)},refresh:function(){return function(){Y.call(this)}.call(this)},setZoom:function(e){B.call(this,e),y(this.elements.zoomer)},rotate:function(e){!function(i){if(!this.options.useCanvas||!this.options.enableOrientation)throw"Croppie: Cannot rotate without enableOrientation && EXIF.js included";var o,r,a=this,s=a.elements.canvas;a.data.orientation=(o=a.data.orientation,r=i,o=(i=-1<l.indexOf(o)?l:u).indexOf(o),r=r/90%i.length,i[(i.length+o+r%i.length)%i.length]),_(s,a.elements.img,a.data.orientation),Z.call(a,!0),W.call(a)}.call(this,e)},destroy:function(){return function(){var e,t,n=this;n.element.removeChild(n.elements.boundary),t="croppie-container",(e=n.element).classList?e.classList.remove(t):e.className=e.className.replace(t,""),n.options.enableZoom&&n.element.removeChild(n.elements.zoomerWrap),delete n.elements}.call(this)}}),T});var lightbox=!1;function kaolightBoxPost(xml){jsonarr=preProcessJSON(xml),lightbox=window.SimpleLightbox.open({items:jsonarr.list.split(",")})}function graphOn(type,el){var box=$("#"+type+"_graph");box.show(),"0"==box.data("loaded")&&(box.css("min-height",box.prev().height()+"px"),box.html(loader(_lang.status_loading)),box.data("loaded","1"),opts={gtype:type},callAjax("user/me_graph",opts,"get",genPost)),box.prev().hide(),$(el).hide().next().show()}function graphOff(box,el){$(el).hide().prev().show();box=$("#"+box+"_graph");box.hide(),box.prev().show()}function graphReload(el){opts=$(el).closest("form").serializeObject(),callAjax("user/me_graph",opts,"get",genPost)}function toggleCoinView(el){val=$(el).is(":checked")?1:0,$.each($("#kcoin_box .kcoin_disp"),function(){$(this).toggle($(this).data("get")==val||0==val)}),setPref("kcoin_gonly",val)}function updateUReibun(lnk,newF){fName=newF,searchUReibun(0)}function searchUReibun(page,sort){page=page||0;sort=sort||$("#ureibun_form input[name=sort]").val(),$("#ureibun_form input[name=sort]").val(sort),$("#ureibun_form input[name=stype]").val(fName),postArr=$("#ureibun_form").serializeObject();$("#ureibun_form input[name=stype]").val();$("#ureibun_"+fName).html(loader(_lang.status_loading)),callAjax("grammar/user_back&pg="+page,postArr,"post",genPost)}function loadGHistory(page,ptype,dspan){callAjax("user/genki_history_back&pg="+page+"&ptype="+ptype+"&span="+dspan,!1,!1,genPost)}function saveStatsSettings(btn,type){for(i in $(btn).html(_lang.status_saving),$(btn).prop("disabled",!0),cols=["left","right"],cols)ids=[],$.each($("#"+type+"_sort_"+cols[i]).children("div"),function(index,el){ids.push($(el).data("statid"))}),$("#"+type+"_form_"+cols[i]).val(ids.join(","));args=$("#"+type+"_settings_form").serializeObject(),args.action="save",callAjax("user/"+type+"_back",args,"post",saveStatsSettingsPost)}function saveStatsSettingsPost(xml){genPost(xml),$(".me_panel_btn").show()}function sStatsSettings(el,show){shd($(el).parents(".sortableBox").children(".settings_desc"),!show),shd($(el).parents(".sortableBox").children(".stats_settings"),show)}function saveProfile(el){postArr=$(el).parents("form").serializeObject(),callAjax("user/me_back",postArr,"post",genPost),tt_Hide(!0)}function loadProfile(btn){contents=$("#edit_js").html(),hooktip(btn,contents,{sticky:!0,spwidth:"600",dir:"below"})}var avatarBox=!1;function loadAvatar(box){avatarBox=box,callAjax("user/me_back","action=lavatar","get",loadAvatarPost)}function loadAvatarPost(xml){tt_Hide(!0),jsonarr=preProcessJSON(xml),hooktip(avatarBox,jsonarr.result,{sticky:!0,spwidth:"400",dir:"below"})}function privStats(type,el,tab){toggle="no"==$(el).data("private")?"yes":"no",$(el).data("private",toggle),"no"==toggle?$(el).addClass("fa-lock").removeClass("fa-unlock-alt"):$(el).addClass("fa-unlock-alt").removeClass("fa-lock"),callAjax("grammar/user_privacy&type="+type+"&toggle="+toggle)}function hideCNote(el){$(el).parent().hide(),setPref("hideCNote","1")}function hideNPanel(el){$(el).prev().hide(),setPref("hideNPanel","1"),$(el).removeClass("little tlnk").addClass("center").html($(el).data("after"))}function loadMeLboard(pg){void 0!==pg&&$("#lboard_pg").val(pg),args={page:"user/me_back",action:"lboard",period:$("#me_lboard_period").val(),pg:$("#lboard_pg").val(),tabs:$("#lboard_tabs").val(),friends:$("#lboard_friends").is(":checked")?1:0,ctab:$("#stats_lboard").find("label.activeTab").attr("id")},div=$("#"+$("#"+args.ctab).attr("for")).next().html(ajaxLoader),callAjax("index.php",args,"get",genPost)}function friendSearch(){""!=$("#friend_search").val()?(opts={action:"fsearch",search:$("#friend_search").val()},$("#friend_search_res").css("color",""),$("#friend_search_res").html(loader(_lang.status_loading)),callAjax("user/study_center_back",opts,"get",genPost)):($("#friend_search_res").html($("#friend_search").data("error")),$("#friend_search_res").css("color","red"))}function friendAdjust(user_id,action,el){opts={friend_id:user_id,action:"friend"},confirmed=!1,"toggle"==action?("0"==$(el).data("current")?(action="add",$(".fbutton_"+user_id).data("current","1"),$(".fbutton_"+user_id).addClass("pure-button-primary"),$(".fbutton_"+user_id).html($(el).data("on"))):(action="remove",$(".fbutton_"+user_id).data("current","0"),$(".fbutton_"+user_id).removeClass("pure-button-primary"),$(".fbutton_"+user_id).html($(el).data("off"))),tt_Hide(!0)):"color"==action&&("0"==$(el).data("current")?(action="add",$(el).data("current","1").html($(el).data("remove"))):(action="remove",$(el).data("current","0").html($(el).data("add")))),"remove"==action?(opts.sub_action="remove",$("#friend_"+user_id)&&$("#friend_"+user_id).remove()):"show_lesson"==action?opts.sub_action=$(el).is(":checked")?"add_lesson":"remove_lesson":"add"==action&&(opts.sub_action="add"),opts.sub_action&&(0<$("#friend_box").length&&(opts.reload_fbox=1),callAjax("user/me_back",opts,"post",genPost),"add"!=action&&"remove"!=action||1!=$("#selector_friend_body").length||"0"==$(el).data("lcount")||loadSets($("#selector_friend_body"),"friend",!0))}function visualizeMn(el,mn_id){showGeneric(el,"quiz/mn_ajax&action=image&mn_id="+mn_id)}function scheduleAOpts(chk){foundUnfrozen=!1,foundAny=0,$.each($(chk).parents(".tabbody").first().find("input:checked"),function(){foundAny++,"0"==$(this).data("frozen")&&(foundUnfrozen=!0)}),sactions=$(chk).parents(".tabbody").first().find(".sched_actions"),sactions.toggle(0<foundAny),foundUnfrozen?(sactions.find(".sched_freeze").show(),sactions.find(".sched_unfreeze").hide()):(sactions.find(".sched_unfreeze").show(),sactions.find(".sched_freeze").hide()),sactions.find(".sched_merge").toggle(1<foundAny)}function freezeSchedules(fstate,btn){opts={action:"freeze",value:fstate?"1":"0"},$(btn).nextAll("div").html(loader(_lang.status_loading)),processSchedules(opts,btn)}function deleteSchedules(btn){opts={action:"delete"},$(btn).nextAll("div").html(loader(_lang.status_loading)),processSchedules(opts,btn)}function mergeSchedulesPre(btn){shw($(btn).nextAll("div")),select=$(btn).nextAll("div").find("select"),select.empty(),$.each($(btn).parents(".tabbody").first().find("input:checked"),function(){select.append("<option value='"+$(this).val()+"'>"+$(this).data("name")+"</option>")})}function mergeSchedulesFinal(btn){sel=$(btn).siblings("select"),opts={action:"merge",sched_id:sel.val(),oscheds:[],toast:1},$.each($(btn).parents(".tabbody").first().find("input:checked"),function(){$(this).val()!=opts.sched_id&&opts.oscheds.push($(this).val())}),$(btn).parents(".tabbody").find(".sched_actions").html(loader(_lang.status_loading)),callAjax("quiz/schedules_ajax",opts,"post",function(xml){opts={action:"load"},genPost(xml),callAjax("quiz/schedules_admin_ajax",opts,"POST",genPost)})}function processSchedules(opts,btn){sids=[],$.each($(btn).parents(".tabbody").first().find("input:checked"),function(){sids.push($(this).val())}),opts.booktype=$(btn).parents(".tabbody").first().data("booktype"),opts.sched_ids=sids,callAjax("quiz/schedules_admin_ajax",opts,"POST",genPost)}function checkCDMult(chk){$(chk).is(":checked")&&1==quizData.ldata.g.length&&($("#cd_mult_warn").addClass("red"),$(chk).prop("checked",!1))}function newPuzzle(el){tip(el,$(el).next().html(),!0)}function getNewPuzzle(){jumpUrl("index.php?page=quiz/schedule_lesson&sched_id="+schedule_id+"&cross=new")}function loadQuizSCDirect(btn){setButton(btn,!1,!0),args={direct:1,booktype:"undefined"==typeof _fbooktype?currentTab().data("booktype"):_fbooktype},args.ldata=compileLists().ldata,"undefined"!=typeof grammarList&&"grammar"==currentTab().data("booktype")&&(args.type=grammarList),callAjax("quiz/setup_quiz",args,"post",loadQuizPost)}function checkQOpts(opt){!$(opt).is(":checked")&&$("#"+$(opt).val()+"_opts").is(":visible")&&$(opt).next().children("div").last().click()}function viewButton(btn,show){show?($(btn).html($(btn).data("close")),$(btn).addClass("pure-button-error")):($(btn).html($(btn).data("click")),$(btn).removeClass("pure-button-error"))}function showQuizOpts(btn,type){if(qopts=["basic","sentence","listen","read","definition","stroke","bushu"],useParent=0<$(btn).parents("#ttip").length?"#ttip":document,currentlyDown=$(useParent).find("#"+type+"_opts").is(":visible"),currentlyDown)$(useParent).find("#"+type+"_opts").slideUp();else{for(i in qopts)type!=qopts[i]&&$(useParent).find("#"+qopts[i]+"_opts").is(":visible")&&(viewButton($(useParent).find("#"+qopts[i]+"_btn"),!1),$(useParent).find("#"+qopts[i]+"_opts").slideUp());$(btn).parent().prevAll("input").prop("checked",!0),$(useParent).find("#"+type+"_opts").slideDown()}}function popMistake(el,wid,lid){tt_Hide(!0),showGeneric(el,"misc/term_suggest_correct&id="+wid+(lid?"&lid="+lid:""))}function customUDef(el){$(el).parent().hide(),$(el).parent().next().show().children("textarea").focus(),setTimeout(function(){resizeTA($(el).parent().next().show().children("textarea"))},300)}function customUDefReset(el){customUDefCancel(el),opts={booktype:$(el).data("booktype"),word_id:$(el).data("id"),action:"reset_def"},callAjax("quiz/custom_def_ajax",opts,"post",genPost)}function customUDefCancel(el){id=$(el).data("id"),$("#cdef_box_"+id).hide().prev().show(),$("#cdef_icn_"+id).show()}function customUDefPost(el){el=$(el).closest(".cdef_opts").prev(),($(el).val()!=$(el).data("orig")&&""!=$(el).val()||$("#dlang_"+$(el).data("id")).val()!=$("#dlang_"+$(el).data("id")).data("orig"))&&(opts={def:$(el).val(),dlang:$("#dlang_"+$(el).data("id")).val(),booktype:$(el).data("booktype"),word_id:$(el).data("id"),approval:$(el).next().find("[data-cdef]").is(":checked")?1:0,action:"custom_def"},callAjax("quiz/custom_def_ajax",opts,"post",genPost)),$(el).parent().hide().prev().show()}function displayFilters(btype){filters=$("#"+btype+"_filters"),_fs=[],$.each(filters.find("input[type='checkbox']:checked"),function(){_fs.push("<span class='tlnk' onclick=\"removeFilter('"+btype+"','"+$(this).data("text")+"'); displayFilters('"+btype+"')\">"+$(this).data("text")+"</span>")}),output=0==_fs.length?"":"<strong>Filters:</strong> "+_fs.join(", "),$("#"+btype+"_filters_disp").html(output),$("#stext_"+btype)&&""!=$("#stext_"+btype).html()&&$("#"+btype+"_japanese")&&""!=$("#"+btype+"_japanese").val()&&$("#"+btype+"_japanese").closest(".search-bar").find(".dsearch").click()}function removeFilter(btype,val){$("#"+btype+"_filters").find("input[data-text='"+val+"']:checked").prop("checked",!1)}function popBoost(wid,type,check){ashi("popBoost "+wid),ashi(type),"string"!=typeof type&&$("#thelist_form").find("[name=booktype]")&&(type=$("#thelist_form").find("[name=booktype]").val()),0<$("#btxt_check_"+wid).length?(nlevel="checked"==$("#btxt_check_"+wid).checked||1==$("#btxt_check_"+wid).checked?"no":"yes",check?nlevel="yes"==nlevel?"no":"yes":toggleBox("btxt_check_"+wid)):(useEl=void 0!==check?$(check):$("#kanji"+wid),nlevel=useEl.hasClass("red")?"no":"yes",0==$("#quiz_introbox").length&&("yes"==nlevel?useEl.addClass("red").removeClass("grey"):useEl.addClass("grey").removeClass("red"))),extraArgs="",$("#thelist #termbox"+wid)&&("undefined"!=typeof sched_altered&&(sched_altered=!0),termbox=$("#thelist #termbox"+wid),termbox_det=!!($(termbox).next().hasClass("inline_lessons")||$(termbox).next().hasClass("full_mbox")||$(termbox).next().hasClass("reibox"))&&$(termbox).next(),"yes"==nlevel?window.liquidReload&&liquidReload(!0):window.liquidReload&&liquidReload(!1),1==$("#hiddenbox").length&&"yes"==nlevel&&(extraArgs="&lrebuild=1",pullHiddenIntro(termbox,termbox_det))),callAjax("quiz/ext_alterboost","wid="+wid+"&alter="+nlevel+"&type="+type+extraArgs,!1,!1)}function tinkerMastery(wid,vector,level,btype,el){opts={level:level,wid:wid,vector:vector},opts.booktype=$("#thelist_form").find("[name=booktype]").val(),ashi("tinkerMastery "+wid),1==$("#hiddenbox").length&&(opts.lrebuild=1),ashi("prior to callajax"),ashi(opts),1==$("#hiddenbox").length?callAjax("misc/mastery_alter",opts,"post"):callAjax("misc/mastery_alter",opts,"post",genPost),ashi("tinker post Ajax call"),$("#thelist #termbox"+wid)&&(ashi("looking for a replacement"),"undefined"!=typeof sched_altered&&(sched_altered=!0),termbox=$("#thelist #termbox"+wid),termbox_det=!!($(termbox).next().hasClass("inline_lessons")||$(termbox).next().hasClass("full_mbox")||$(termbox).next().hasClass("reibox"))&&$(termbox).next(),window.liquidReload&&liquidReload(!0),1==$("#hiddenbox").length&&(ashi("Found the #hiddenbox"),pullHiddenIntro(termbox,termbox_det))),0==$("#hiddenbox").length&&(0==level?$("#intro_tinker_desc").html($("#intro_tinker_desc").data("unknown")):$("#intro_tinker_desc").html($("#intro_tinker_desc").data("known")),$(el).parent().find("span").removeClass("cunderline"),$(el).find("span").addClass("cunderline"))}function suppReservePost(xml){var jsonarr=preProcessJSON(xml);if(jsonarr.idlist){for(i in jsonarr.idlist=jsonarr.idlist.split(","),jsonarr.idlist)hiddenIds.push(jsonarr.idlist[i]);$("#hiddenbox").append(jsonarr.thelist)}}function termExclude(el,wid){nlevel=$(el).hasClass("ki_active")?"yes":"no",$(el).toggleClass("ki_active"),$(el).toggleClass("hterm"),callAjax("quiz/ext_alterboost","wid="+wid+"&alter="+nlevel+"&type=kanji",!1,!1)}function learnedKanji(kid,check,type,el){var tog;null==type&&(type="kanji"),null!=el?"yes"==(tog=$(el).hasClass("grey")?"yes":"no")?($(el).removeClass("grey").addClass("dorange"),$.each($(".ws_"+kid),function(){void 0!==$(this).data("msg")&&$(this).data("msg",$(this).data("msg").replace("far grey","far dorange"))}),$("#whint_"+kid).removeClass("grey").addClass("dorange")):($(el).removeClass("dorange").addClass("grey"),$.each($(".ws_"+kid),function(){void 0!==$(this).data("msg")&&$(this).data("msg",$(this).data("msg").replace("far dorange","far grey"))}),$("#whint_"+kid).removeClass("dorange").addClass("grey")):(tog="checked"==returnEl(type+"_learned_check").checked||1==returnEl(type+"_learned_check").checked?"no":"yes",check?tog="yes"==tog?"no":"yes":toggleBox(type+"_learned_check")),callAjax("misc/kanji_learned&kid="+kid+"&toggle="+tog+"&type="+type)}function make_visible(lnk){return 0<$("#ans").length&&(sAns=$("#ans").hasClass("rhidden"),shd("ans",sAns),shd(lnk,!sAns),lnk.blur()),!1}var bindSentenceEl,masteryBox=!1;function loadMastery(el,wid,vector,btype,sid){masteryBox=$(el),sid=void 0!==sid?"&sid="+sid:"",callAjax("misc/mastery_alter&wid="+wid+"&vector="+vector+"&booktype="+btype+sid,!1,!1,displayMastery)}function displayMastery(jsonarr){jsonarr=preProcessJSON(jsonarr);tt_Hide(!0),tip(masteryBox,jsonarr.body,!0,"420")}function setMastery(wid,vector,level,btype){tt_Hide(!0),callAjax("misc/mastery_alter&level="+level+"&wid="+wid+"&vector="+vector+"&booktype="+btype,!1,!1,reloadMastery)}function reloadMastery(jsonarr){genPost(jsonarr);jsonarr=preProcessJSON(jsonarr);jsonarr.width?masteryBox.find(".star").first().css({width:jsonarr.width+"px"}):masteryBox.html(jsonarr.inner)}function cancelSchedule(btn){for(i in $(btn).html('<i class="fa fa-circle-o-notch fa-spin fa-fw"></i>').attr("disabled",!0),adjustedLists){for(j in _newList=[],adjustedLists[i])_newList.push(j+"="+("off"==adjustedLists[i][j]?"on":"off"));adjustedLists[i]=_newList}args={action:"lib_adopt",sched_id:sched_id,lists:adjustedLists,booktype:sBookType},callAjax("user/study_center_back",args,"post",function(){jumpUrl("index.php?page=quiz/schedule_lesson&sched_id="+sched_id)})}function finalizeSchedule(frm){if(hde($(frm).find("#msched_error")),args=$(frm).serializeObject(),setButton($(frm).find("#msched_button"),!1),"undefined"!=typeof quizData)for(i in quizData)args[i]=quizData[i];args.action="finalize",callAjax("quiz/create_schedule",args,"post",finalizeSchedulePost)}function finalizeSchedulePost(xml){return setButton($("#msched_button"),!0),jsonarr=jQuery.parseJSON(xml),jsonarr.error?$("#msched_error")&&(shw($("#msched_error")),$("#msched_error").children().last().html(jsonarr.error)):jumpUrl(jsonarr.redirect),jsonarr}function loadKIndex(pg){null==pg&&(pg=_pg||0),shw("thelist_load"),hde("thelist");var postArgs=$("#thelist_form").serializeObject();return postArgs.pg=pg,callAjax("user/kanji_index_back",postArgs,"POST",genPost),!1}function learnedIKanji(el,kid){var tog=$(el).hasClass("ki_active")?"no":"yes";$(el).toggleClass("ki_active"),callAjax("misc/kanji_learned&kid="+kid+"&toggle="+tog)}function adjustAdoption(el,type,list_id,booktype){lists={o:[],c:[],g:[]},lists[type].push(list_id),adjustAdoptionBack(el,lists,booktype)}function adjustAdoptionMulti(el,lists,booktype){var newAdoption;parent=$(el).parents(".rl_group").first(),0<$(parent).next().next().find(".flbox").length&&(newAdoption="0"==$(el).data("adopted")?"1":"0",$.each($(parent).next().next().find(".flbox").find("button.sched"),function(){$(this).data("adopted")!=newAdoption&&adjustAdoptionBack(this,{},booktype,!0)})),adjustAdoptionBack(el,lists,booktype)}function adjustAdoptionBack(el,lists,booktype,returnVal){args={action:"lib_adopt",booktype:booktype};var str="0"==$(el).data("adopted")?"on":"off";if("undefined"!=typeof adjustedLists)for(i in lists)for(j in lists[i])void 0!==adjustedLists[i][lists[i][j]]&&adjustedLists[i][lists[i][j]]!=str?delete adjustedLists[i][lists[i][j]]:adjustedLists[i][lists[i][j]]=str;for(i in lists)for(j in lists[i])lists[i][j]=lists[i][j]+"="+str;return $(el).data("adopted",Math.abs($(el).data("adopted")-1)),"undefined"!=typeof sched_id&&(args.sched_id=sched_id,$(el).toggleClass("pure-button-sched","on"==str),num_items="on"==str?$(el).data("tcount"):-1*parseInt($(el).data("tcount")),$("#numterms").html(Math.max(0,num_items+parseInt($("#numterms").html()))),$("#selector_insched").is(":checked")||$("#selector_insched_body").html("")),$(el).find("span").html($(el).data(str+"-text")),$(el).html("<i class='far fa-lg "+$(el).data(str+"-icon")+"'></i> "+$(el).data(str+"-text")),void 0===returnVal&&"undefined"!=typeof sched_id&&adjustSelectAll(el),args.lists=lists,void 0===returnVal&&callAjax("user/study_center_back",args,"post"),$("#selector_saved").is(":checked")||null!=typeof sched_id||$("#selector_saved_body").html(""),args}function adjustSelectAll(btn){allOn=0==$(btn).parents(".inline_lessons").find("button.sched").filter(function(index){return!$(this).hasClass("pure-button-sched")}).length,pBtn=$(btn).parents(".inline_lessons").prev().prev().find("button.sched").first(),str=allOn?($(pBtn).data("adopted","1"),"on"):($(pBtn).data("adopted","0"),"off"),$(pBtn).find("span").html($(pBtn).data(str+"-text")),$(pBtn).find("i").filter(".fa, .far").attr("class","fa fa-lg "+$(pBtn).data(str+"-icon")),$(pBtn).toggleClass("pure-button-sched",allOn)}function selectAll(id){allOn=0==$("#"+id).find("input:not(:checked)").length,$.each($("#"+id).find("input"),function(){$(this).prop("checked",!allOn)})}function osearchBox(el,type){$(el).removeClass("lnk").addClass("bolded"),$(el).siblings().removeClass("bolded").addClass("lnk"),oBoxes=$(el).parent().next(),oBoxes.children().filter(".osearch_"+type).show(),oBoxes.children().not(".osearch_"+type).each(function(){$(this).hide()})}function makeSchedule(btn,booktype){args={booktype:booktype,action:"init"},showGeneric(btn,"quiz/create_schedule&"+$.param(args),!0)}function createLesson(use_booktype){jumpUrl("index.php?page=custom/list_edit&booktype="+use_booktype+"&action=new")}function editLesson(list_id,booktype){opts={action:"edit",list_id:list_id},void 0!==booktype&&(opts.booktype=booktype),prepTermModal(),callAjax("custom/list_edit_ajax",opts,"get",genPost)}function multiLoad(el,errid){list_id=[],ltype=booktype=!1,$.each($(el).parent().parent().parent().next().find("input[name='lcheck']:checked"),function(){ltype=$(this).data("type"),booktype=$(this).data("booktype"),list_id.push($(this).data("list_id"))}),0!=list_id.length?($("#"+errid).hide(),opts={},opts[ltype]=list_id,loadQOptions(booktype,opts,el)):$("#"+errid).show().html($(el).data("error"))}function multiStart(el){lbtn=$(el).parent().prevAll("button"),parent=$(el).parents(".rl_group").first(),0==$(el).data("expanded")&&0==lbtn.data("expanded")&&lbtn.click(),$(el).data("expanded",0==$(el).data("expanded")?1:0),$(el).html("1"==$(el).data("expanded")?$(el).data("ac"):$(el).data("un")),parent.toggleClass("multi_select",1==$(el).data("expanded"))}function delUComment(cid,rid){hde("ucomment_block_"+cid),restripe($("#ucomment_block_"+cid).parents().id,!0),tt_Hide(!0),callAjax("grammar/individual_back","action=del_ucomment&cid="+cid),$("#ureibun_ccount_"+rid).html(parseInt($("#ureibun_ccount_"+rid).html())-1),$("#ureibun_ccount2_"+rid).html(parseInt($("#ureibun_ccount2_"+rid).html())-1)}function editUComment(comment_id){frm=$("#edit_ucomment_"+comment_id),args=frm.serializeObject(),args.action="edit_ucomment",""==args.message?(shw("edit_ucomment_error_"+comment_id),$("#edit_ucomment_error_"+comment_id).html($("#edit_ucomment_error_"+comment_id).data("empty"))):(hde("edit_ucomment_error_"+comment_id),setButton("#edit_ucomment_submit_"+comment_id,!1),callAjax("grammar/individual_back",args,"post",editUCommentPost))}function editUCommentPost(jsonarr){jsonarr=preProcessJSON(jsonarr);setButton("#edit_ucomment_submit_"+jsonarr.idmarker,!0),jsonarr.error?(shw("edit_ucomment_error_"+jsonarr.idmarker),$("#edit_ucomment_error_"+jsonarr.idmarker).html(jsonarr.error)):($("#buffbox").html(jsonarr.result),el=$("#buffbox").children().eq(0).html(),$("#buffbox").html(""),$("#ucomment_block_"+jsonarr.idmarker).html(el))}function submitUComment(urid){frm=$("#add_ucomment_"+urid),args=frm.serializeObject(),args.action="add_ucomment",""==args.comment?(shw("add_ucomment_error_"+urid),$("#add_ucomment_error_"+urid).html($("#add_ucomment_error_"+urid).data("comment"))):""==args.improved?(shw("add_ucomment_error_"+urid),$("#add_ucomment_error_"+urid).html($("#add_ucomment_error_"+urid).data("sugg"))):(hde("add_ucomment_error_"+urid),setButton("#add_ucomment_submit_"+urid,!1),callAjax("grammar/individual_back",args,"post",submituCommentPost))}function submituCommentPost(jsonarr){jsonarr=preProcessJSON(jsonarr);setButton("#add_ucomment_submit_"+jsonarr.idmarker,!0),jsonarr.error?(shw("add_ucomment_error_"+jsonarr.idmarker),$("#add_ucomment_error_"+jsonarr.idmarker).html(jsonarr.error)):($("#add_ucomment_form_"+jsonarr.idmarker).html(jsonarr.form),$("#ureibun_box_"+jsonarr.idmarker).html($("#ureibun_box_"+jsonarr.idmarker).html()+jsonarr.result),restripe("ureibun_box_"+jsonarr.idmarker,!0),$("#ureibun_ccount_"+jsonarr.idmarker).html(parseInt($("#ureibun_ccount_"+jsonarr.idmarker).html())+1),$("#ureibun_ccount2_"+jsonarr.idmarker).html(parseInt($("#ureibun_ccount2_"+jsonarr.idmarker).html())+1)),checkToast(jsonarr)}function submitUReibun(btn,opts){suffix="",opts.suffix&&(suffix="_"+opts.suffix),frm=$("#add_ureibun_"+opts.idmarker+suffix),args=frm.serializeObject(),args.action="add_ureibun",""==args.sentence?alertBox($("#ureibun_error_"+opts.idmarker+suffix).data("empty"),!0,"ureibun_error_"+opts.idmarker+suffix):(hde("ureibun_error_"+opts.idmarker+suffix),setButton(btn,!1),postPages={grammar:"grammar/individual_back",haiku:"community/haiku_back",mashup:"community/niwa_back",hanashi:"community/hanashi_back"},callAjax(postPages[opts.type],args,"post",submitUReibunPost))}function submitUReibunPost(jsonarr){jsonarr=preProcessJSON(jsonarr);if(suffix="",jsonarr.suffix&&(suffix="_"+jsonarr.suffix),jsonarr.error)setButton("#addureibun_submit_"+jsonarr.idmarker+suffix,!0),alertBox(jsonarr.error,!0,"ureibun_error_"+jsonarr.idmarker+suffix);else{if(jsonarr.redirect)return void jumpUrl(jsonarr.redirect);setButton("#addureibun_submit_"+jsonarr.idmarker+suffix,!0),"hanashi"==jsonarr.target?($("#add_ureibun_"+jsonarr.idmarker+suffix).find("input[type=text], textarea").val(""),$("#hanashi_form_box"+suffix).slideUp(400,function(){shw("#hanashi_form_button"+suffix)}),$("#ureibun_block_reply"+suffix).before(jsonarr.result),restripe("ureibun_body_"+jsonarr.idmarker+suffix,!0)):($("#ureibun_body_"+jsonarr.idmarker+suffix).show(),$("#links_top_box_"+jsonarr.idmarker+suffix).show(),$("#links_bottom_box_"+jsonarr.idmarker+suffix).show(),$("#ureibun_body_"+jsonarr.idmarker+suffix),$("#add_ureibun_form_"+jsonarr.idmarker+suffix).html(jsonarr.form),$("#ureibun_body_"+jsonarr.idmarker+suffix).html(jsonarr.result+$("#ureibun_body_"+jsonarr.idmarker+suffix).html()),$("#ureibun_count_"+jsonarr.idmarker+suffix).html(parseInt($("#ureibun_count_"+jsonarr.idmarker+suffix).html())+1),restripe("ureibun_body_"+jsonarr.idmarker+suffix),!1!==writeButton&&shw(writeButton))}checkToast(jsonarr)}function delUReibun(rid,mid){hde("ureibun_block_"+rid),restripe($("#ureibun_block_"+rid).parents().id),tt_Hide(!0),callAjax("grammar/individual_back","action=del_ureibun&urid="+rid,"post",genPost),$("#ureibun_mcount_"+mid).html(parseInt($("#ureibun_mcount_"+mid).html())-1)}function editUReibun(mnote_id,opts){void 0===opts&&(opts={}),frm=$("#edit_ureibun_"+mnote_id),args=frm.serializeObject(),args.action="edit_ureibun",""==args.sentence?alertBox($("#ureibun_error_"+mnote_id).data("empty"),!0,"ureibun_error_"+mnote_id):(hde("ureibun_error_"+mnote_id),setButton("#editureibun_submit_"+mnote_id,!1),callAjax("grammar/individual_back",args,"post",editUReibunPost))}function editUReibunPost(jsonarr){jsonarr=preProcessJSON(jsonarr);setButton("#editureibun_submit_"+jsonarr.idmarker,!0),jsonarr.error?($("#ureibun_error_"+jsonarr.idmarker+" > div:last-of-type").html(jsonarr.error),$("#ureibun_error_"+jsonarr.idmarker).removeClass("rhidden")):($("#buffbox").html(jsonarr.result),el=$("#buffbox").children().eq(0).html(),$("#buffbox").html(""),$("#ureibun_block_"+jsonarr.idmarker).html(el))}function alertBox(txt,icn,id){var cname=icn?"alertwarn":"alertsucc",icn=icn?'<i class="far fa-exclamation-triangle fa-2x"></i>':'<i class="far fa-check-circle fa-2x"></i>';$("#"+id).show().html('<div class="alertbox '+cname+' flexbox fcenter"><div>'+icn+'</div><div class="grow">'+txt+"</div></div>")}function rateSentence(sid,rate,el,wid){args={sid:sid,rate:rate,word_id:wid},""!=$("#rlinks_"+sid).html()&&("useful"==rate?($("#useful_"+sid).find("i").hasClass("green")?(args.remove=1,$("#useful_"+sid).find("i").removeClass("like_mark green").addClass("lgreen")):$("#useful_"+sid).find("i").addClass("like_mark green").removeClass("lgreen"),$("#useless_"+sid).find("i").removeClass("like_mark red").addClass("lred")):($("#useless_"+sid).find("i").hasClass("red")?(args.remove=1,$("#useless_"+sid).find("i").removeClass("like_mark red").addClass("lred")):$("#useless_"+sid).find("i").addClass("like_mark red").removeClass("lred"),$("#useful_"+sid).find("i").removeClass("like_mark green").addClass("lgreen")),"useful"!=rate&&void 0===args.remove&&showGeneric($("#rlinks_"+sid),"misc/reibun_correct&popup=true&sid="+sid+"&action=form")),callAjax("misc/sentence_rate",args)}function toggleUReibuns(id){par=$("#"+id).parents(".tabbody").first(),par.children().eq(1).is(":visible")?par.children("div:not(#"+id+")").hide():par.children("div:not(#"+id+")").show()}function sentenceCorrect(){callAjax("misc/reibun_correct",$("#reibun_correct").serializeObject(),"post"),tt_Hide(!0)}function showPAddReibun(el,wid){showGeneric(el,"misc/reibun_privateadd&wid="+wid+"&action=insert",!0)}function savePReibun(el){shw("save_private_msg"),hde("private_sentence_form");var sendVars={action:"save"};sendVars.wid=$("#private_wid").val(),sendVars.private_sentence=$("#private_sentence").val(),0<$("#bind_dict").length&&$("#bind_dict").attr("checked")&&(sendVars.bind_dict=!0),callAjax("misc/reibun_privateadd",sendVars,"post",savePReibunPost)}function savePReibunPost(xml){jsonarr=preProcessJSON(xml),hde("save_private_msg"),jsonarr.error&&($("#private_sentence").val(jsonarr.error),shw("private_sentence_form")),$("#linked_sid")&&jsonarr.sid?($("#linked_sid").val(jsonarr.sid),$("#sentence").val(jsonarr.japanese),bindPReibun($("#messages"),jsonarr.sid),$("#messages").html(loader(""))):$("#messages").html(jsonarr.messages)}function deletePReibun(el,rid){_confirm($(el).data("confirm"),function(){hde($("#rfull_"+rid)),callAjax("misc/reibun_privateadd","rid="+rid+"&action=delete","post")})}function editPReibun(el,rid,wid){showGeneric(el,"misc/reibun_privateadd&rid="+rid+"&wid="+wid+"&action=edit")}function editPReibunPost(el,rid,wid){hde("preibun_edit_body"),shw("preibun_edit_body_wait"),callAjax("misc/reibun_privateadd","rid="+rid+"&action=editsave&wid="+wid+"&japanese="+$("#preibun_edit").val()+"&english="+$("#preibun_edit_english").val(),"post",genPost)}function addG(index,code){returnEl(index).val(returnEl(index).val()+code+" "),returnEl(index).focus()}function usageAddEx(uid,mid){var args={action:"add"};args.search=$("#addex_"+uid+"_"+mid).val(),args.usage_id=uid,args.meaning_id=mid,callAjax("grammar/individual_addex",args,"post",genPost),$("#addex_"+uid+"_"+mid).val("")}function usageAddExAlter(uid,mid,term,el){var args={};args.usage_id=uid,args.meaning_id=mid,args.mb_id=term,sel=$("#mbit_"+term),sel.parentNode.removeChild(sel),args.action="rem",callAjax("grammar/individual_addex",args,"post")}function suggestPolite(el,mid){tt_Hide(!0),$("#pmeaning_id").val(mid),tip(el,$("#suggest_polite").html(),!0,"600","","suggest_polite")}function suggestRelated(el,mid){tt_Hide(!0),$("#meaning_id").val(mid),tip(el,$("#suggest_meaning").html(),!0,"600","","suggest_meaning")}function rateNote(mnote_id,el,val){$("#urate_"+mnote_id).html("up"==val?parseInt($("#urate_"+mnote_id).html())+1:parseInt($("#urate_"+mnote_id).html())-1),hde(returnEl(el).parents("div").first()),callAjax("grammar/individual_nrate&mnote_id="+mnote_id+"&rate="+val)}function addGSentence(mid){form=$("#add_gsentence_"+mid),params=form.serializeObject(),callAjax("grammar/individual_add_gsentence",params,"post",addGPost),$("#addg_button_"+mid).prop("disabled",!0)}function addGPost(xml){var jsonarr=preProcessJSON(xml);$("#g_japanese_"+jsonarr.meaning_id).val(""),$("#g_english_"+jsonarr.meaning_id).val(""),$("#addg_button_"+jsonarr.meaning_id).prop("disabled",!1),$("#added_sentences_"+jsonarr.meaning_id).html(jsonarr["added_sentences_"+jsonarr.meaning_id]),genPost(xml)}function searchPSent(offset,el){hde("ureibun_body_inner"),hde("ureibun_recent"),hde("ureibun_links"),shw("ureibun_body_search"),$("#ureibun_body_inner").html(""),params={private:"1",sent_offset:offset||""},callAjax("misc/ext_reibun_search",params,"post",genPost)}function bindPReibun(el,rid){bindSentenceEl=el,callAjax("user/ureibun_setraw&urid="+rid+"&action=load&type=private",!1,"post",bindUPost)}function bindUReibun(el,rid,revid){tip(el,_lang.status_loading,!0,600,""),bindSentenceEl=el,callAjax("user/ureibun_setraw&urid="+rid+"&rev_id="+revid+"&action=load",!1,"post",bindUPost)}function bindUPost(xml){var jsonarr=preProcessJSON(xml);tt_Hide(!0),tt_Hide(!0),jsonarr.finish?(null!=jsonarr.fsentence?$("#displayj_"+jsonarr.reibun_id).html(jsonarr.fsentence):null!=jsonarr.rsentence&&$("#rjap_"+jsonarr.reibun_id).html(jsonarr.rsentence),genPost(xml)):(tip(bindSentenceEl,jsonarr.body,!0,"800",jsonarr.title,!1,!1,!1,{align:"center"}),fixedHeightTip(),verticalCenter())}function bindUSend(rid,revid,action){var form=$("#uparse_"+rid+"_"+revid);"reparse"==action&&($("#reparse_"+rid+"-"+revid).val("Parsing..."),$("#reparse_"+rid+"-"+revid).prop("disabled",!0)),callAjax("user/ureibun_setraw&urid="+rid+"&rev_id="+revid+"&action="+action,form.serializeObject(),"post",bindUPost)}function etoggle(elem,rid,index){returnEl(elem).toggleClass("red"),$("#einput_"+rid+"_"+index).val("1"==$("#einput_"+rid+"_"+index).val()?"":"1")}function jtoggle(elem,rid,index){returnEl(elem).toggleClass("red"),$("#jinput_"+rid+"_"+index).val("1"==$("#jinput_"+rid+"_"+index).val()?"":"1")}function jtoggle2(elem,rid,index){returnEl(elem).toggleClass("red"),$("#jinput2_"+rid+"_"+index).val("1"==$("#jinput2_"+rid+"_"+index).val()?"":"1")}function wordConj(el,id){return showGeneric(el,"misc/word_conjtable&id="+id)}function recolor_build(rid){for(i in keys=["jap","jap2","eng"],keys)1==$("#"+keys[i]+"_"+rid).length&&(temp=[],$.each($("#recolor_"+rid).find("."+keys[i]+"_"+rid+".red"),function(){temp.push($(this).data("rid"))}),$("#"+keys[i]+"_"+rid).val(temp.join(",")))}function recolor_toggle(elem){$(elem).hasClass("red")?$(elem).removeClass("red"):$(elem).addClass("red")}function unique(array){return array.filter(function(el,index,arr){return index==arr.indexOf(el)})}!function($){$.fn.iframePostForm=function(options){var response,returnReponse,element,status,iframe;return options=$.extend({},$.fn.iframePostForm.defaults,options),$("#"+options.iframeID).length||$("body").append('<iframe id="'+options.iframeID+'" name="'+options.iframeID+'" style="display:none" />'),$(this).each(function(){(element=$(this)).attr("target",options.iframeID),element.submit(function(){return!1===(status=options.post.apply(this))?status:void(iframe=$("#"+options.iframeID).load(function(){response=iframe.contents().find("body"),returnReponse=options.json?$.parseJSON(response.html()):response.html(),options.complete.apply(this,[returnReponse]),iframe.unbind("load"),setTimeout(function(){response.html("")},1)}))})})},$.fn.iframePostForm.defaults={iframeID:"iframe-post-form",json:!1,post:function(){},complete:function(response){}}}(jQuery);
//# sourceMappingURL=https://www.renshuu.org/main/main.defer.min.js.map